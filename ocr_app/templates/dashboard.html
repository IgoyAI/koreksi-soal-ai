{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
  <h1 class="mb-4">Dashboard</h1>
  <button class="btn btn-primary mb-3" data-toggle="modal" data-target="#projectModal">New Project</button>
  {% if not projects %}
    <p>No projects yet.</p>
  {% else %}
    {% for project in projects %}
      {% set pid = loop.index0 %}
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="card-title mb-0">{{ project.name }}</h3>
          <div class="dropdown">
            <button class="btn btn-tool" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <i class="fas fa-ellipsis-v"></i>
            </button>
            <div class="dropdown-menu dropdown-menu-right">
              <a class="dropdown-item" href="{{ url_for('view_project', pid=pid) }}"><i class="fas fa-eye mr-1"></i>View</a>
              <a class="dropdown-item" href="{{ url_for('edit_project', pid=pid) }}"><i class="fas fa-edit mr-1"></i>Edit</a>
              <form action="{{ url_for('delete_project', pid=pid) }}" method="post" onsubmit="return confirm('Delete project?')">
                <button type="submit" class="dropdown-item"><i class="fas fa-trash mr-1"></i>Delete</button>
              </form>
              <a class="dropdown-item" href="#" data-toggle="modal" data-target="#examModal{{ pid }}"><i class="fas fa-plus mr-1"></i>Add Exam</a>
            </div>
          </div>
        </div>
        <div class="card-body">
          {% if not project.exams %}
            <p class="mb-0">No exams.</p>
          {% else %}
            {% for exam in project.exams %}
              {% set eid = loop.index0 %}
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                  <a class="text-body" data-toggle="collapse" href="#results-{{ pid }}-{{ eid }}" role="button" aria-expanded="false" aria-controls="results-{{ pid }}-{{ eid }}">
                    {{ exam.name }}
                  </a>
                </h5>
                <div>
                  <a href="{{ url_for('view_exam', pid=pid, eid=eid) }}" class="btn btn-sm btn-info"><i class="fas fa-eye mr-1"></i>View</a>
                  <a href="{{ url_for('ocr_exam', pid=pid, eid=eid) }}" class="btn btn-sm btn-primary"><i class="fas fa-camera mr-1"></i>OCR</a>
                  <a href="{{ url_for('edit_exam', pid=pid, eid=eid) }}" class="btn btn-sm btn-warning"><i class="fas fa-edit mr-1"></i>Edit</a>
                  <form action="{{ url_for('delete_exam', pid=pid, eid=eid) }}" method="post" style="display:inline">
                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete exam?')"><i class="fas fa-trash mr-1"></i>Delete</button>
                  </form>
                </div>
              </div>
              <div class="collapse mt-2" id="results-{{ pid }}-{{ eid }}">
                {% if exam.results %}
                  <ul class="list-group mb-3">
                    {% for r in exam.results %}
                      <li class="list-group-item d-flex justify-content-between">
                        <span>{{ r.filename }}</span>
                        <span>{{ r.score }} / {{ exam.num_questions }}</span>
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <p>No results yet.</p>
                {% endif %}
              </div>
            {% endfor %}
          {% endif %}
        </div>
      </div>
      <div class="modal fade" id="examModal{{ pid }}" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <form method="post" action="{{ url_for('create_exam', pid=pid) }}">
              <div class="modal-header">
                <h5 class="modal-title">New Exam</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <div class="form-group">
                  <label for="exam-name-{{ pid }}">Name</label>
                  <input type="text" class="form-control" id="exam-name-{{ pid }}" name="name" required>
                </div>
                <div class="form-group">
                  <label for="exam-num-{{ pid }}">Number of Questions</label>
                  <input type="number" class="form-control" id="exam-num-{{ pid }}" name="num_questions" min="1" max="100" required>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Create</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endfor %}
  {% endif %}
  <div class="modal fade" id="projectModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <form method="post" action="{{ url_for('create_project') }}">
          <div class="modal-header">
            <h5 class="modal-title">New Project</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="project-name">Name</label>
              <input type="text" class="form-control" id="project-name" name="name" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Create</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}
